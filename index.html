<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>WordMap | ArcGIS Maps SDK for JavaScript</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.30/esri/themes/light/main.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@esri/calcite-components@1.0.0-beta.82/dist/calcite/calcite.css"
    />
    <script src="https://js.arcgis.com/4.30/"></script>
    <script
      type="module"
      src="https://unpkg.com/@esri/calcite-components@1.0.0-beta.82/dist/calcite/calcite.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/@esri/calcite-components@1.0.0-beta.82/dist/calcite/calcite.js"
    ></script>

    <style>
      html,
      body,
      #container {
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: row;
      }

      #leftPanel {
        width: 20%;
        display: flex;
        flex-direction: column;
        padding: 6px;
        background-color: #f4fff3;
        overflow-y: auto;
      }

      #infoPanel {
        flex: 1;
      }

      #inputPanel {
        width: 100%;
        padding: 10px;
        background-color: #39ca51;
      }

      #inputPanel textarea {
        width: 90%;
        height: 100px;
        padding: 2px;
        font-size: 14px;
        box-sizing: border-box;
        resize: vertical;
      }

      #viewDiv {
        flex: 2;
        background-color: #f0f0f0;
      }

      #imagePanel {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        box-sizing: border-box;
        background-color: #f4fff3;
      }

      #imagePanel img {
        max-width: 100%;
        max-height: 100%;
        margin-bottom: 10px; /* Space between image and text */
      }

      #placeholderTop,
      #placeholderBottom {
        margin-top: 10px; /* Adjust as needed */
        text-align: center;
      }

      #placeholderTop p,
      #placeholderBottom p {
        overflow-wrap: break-word; /* Wrap long words */
        max-width: 100%; /* Limit width */
      }
    </style>
    <script>
      require([
        "esri/Map",
        "esri/layers/GraphicsLayer",
        "esri/views/MapView",
        "esri/widgets/BasemapToggle",
        "esri/Graphic",
        "esri/geometry/Point",
        "esri/PopupTemplate",
      ], (
        Map,
        GraphicsLayer,
        MapView,
        BasemapToggle,
        Graphic,
        Point,
        PopupTemplate
      ) => {
        const graphicsLayer = new GraphicsLayer();

        const map = new Map({
          basemap: "satellite",
          layers: [graphicsLayer],
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 13,
          center: [-177.366, 28.2],
        });

        view.when(() => {
          const basemapToggle = new BasemapToggle({
            view: view,
            nextBasemap: "topo-vector",
          });

          view.ui.add(basemapToggle, "top-left");

          function addPoint(longitude, latitude, title) {
            const point = new Point({
              longitude: longitude,
              latitude: latitude,
            });

            const popupTemplate = new PopupTemplate({
              title: title,
              content: `Latitude: {latitude}<br>Longitude: {longitude}`,
            });

            const markerSymbol = {
              type: "simple-marker",
              color: [226, 119, 40], // Orange
              outline: {
                color: [255, 255, 255], // White
                width: 2,
              },
            };

            const pointGraphic = new Graphic({
              geometry: point,
              symbol: markerSymbol,
              attributes: {
                latitude: latitude,
                longitude: longitude,
              },
              popupTemplate: popupTemplate,
            });

            graphicsLayer.add(pointGraphic);
            view.center = point;
            view.zoom = 13;
          }

          // Initial point for Midway Island
          addPoint(-177.366, 28.2, "Midway Island");

          document
            .getElementById("submitButton")
            .addEventListener("click", () => {
              // Get query
              const userInput = document.getElementById("userInput").value;

              const url = "http://127.0.0.1:5000/historyQuery";
              const data = { query: userInput };

              fetch(url, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Network response was not ok");
                  }
                  return response.json();
                })
                .then((data) => {
                  console.log("Success:", data);
                  // Display paragraph text
                  const infoPanel = document.getElementById("imagePanel");
                  infoPanel.innerText = data["paragraph_response"];

                  const eventsList = data["relev_events_list"];
                  console.log(eventsList);

                  // Add points for each event in the eventsList
                  eventsList.forEach((event) => {
                    const { x, y, "tag line": tagLine } = event;
                    addPoint(x, y, tagLine);
                  });
                })
                .catch((error) => {
                  console.error("Error:", error);
                });

              // Clear the input box and update the query text
              document.getElementById("queryText").innerText = `${userInput}`;
              document.getElementById("userInput").value = "";
            });

          // Event listener for the clear button
          document
            .getElementById("clearButton")
            .addEventListener("click", () => {
              graphicsLayer.removeAll();
              document.getElementById("queryText").innerText = "";
            });

          view.on("pointer-move", (event) => {
            view.hitTest(event).then((response) => {
              const results = response.results;
              if (results.length > 0 && results[0].graphic) {
                const graphic = results[0].graphic;
                const latitude = graphic.attributes.latitude;
                const longitude = graphic.attributes.longitude;

                view.popup.open({
                  location: graphic.geometry,
                  title: graphic.popupTemplate.title,
                  content: `Latitude: ${latitude}<br>Longitude: ${longitude}`,
                });
              } else {
                view.popup.close();
              }
            });
          });
        });
      });
    </script>
  </head>

  <body>
    <div id="container">
      <div id="leftPanel">
        <div id="infoPanel">
          <div id="inputPanel">
            <textarea
              id="userInput"
              placeholder="Enter query: "
              rows="5"
            ></textarea>
            <calcite-button id="submitButton" appearance="solid" color="blue"
              >Submit</calcite-button
            >
            <calcite-button id="clearButton" appearance="outline" color="red"
              >Clear All Points</calcite-button
            >
          </div>

          <p><strong>Query: </strong></p>
          <p id="queryText"></p>
        </div>
      </div>

      <div id="viewDiv"></div>

      <div id="imagePanel">
        <div id="placeholderTop">
          <p>sadasdasdas</p>
        </div>
        <img
          src="https://i0.wp.com/port2flavors.com/wp-content/uploads/2022/07/placeholder-614.png?fit=1200%2C800&ssl=1"
          alt="Placeholder Image"
        />
        <div id="placeholderBottom">
          <p>adasdasd</p>
          <p>
            The Battle of Midway, fought from June 4-7, 1942, was a pivotal
            naval engagement during World War II between the United States and
            Imperial Japan. Taking place six months after the attack on Pearl
            Harbor, Midway marked a crucial turning point in the Pacific
            Theater. The American forces, under Admiral Chester W. Nimitz,
            intercepted and decisively defeated a Japanese fleet aiming to
            occupy Midway Atoll. Through skillful tactics and
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
